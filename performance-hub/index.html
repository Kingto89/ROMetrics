<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROMetrics â€” Performance Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --panel-2:#111827; --muted:#9ca3af; --text:#e5e7eb; --brand:#ef4444; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --card:#0f172a; --ring:rgba(239,68,68,.3);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);}
    a{color:#93c5fd;text-decoration:none}
    .app{display:grid;grid-template-columns:320px 1fr;min-height:100%}
    .sidebar{background:var(--panel);border-right:1px solid #1f2937;padding:20px;position:sticky;top:0;height:100svh;overflow:auto}
    .header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .logo{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,#ef4444,#dc2626);display:grid;place-items:center;font-weight:800}
    .title{font-weight:800;letter-spacing:.2px}
    .bubble{display:inline-flex;align-items:center;gap:10px;background:#111827;border:1px solid #1f2937;padding:10px 12px;border-radius:12px;margin:2px 0}
    .bubble .dot{width:8px;height:8px;border-radius:999px;background:#22d3ee}
    .muted{color:var(--muted)}
    .sep{height:1px;background:#1f2937;margin:16px 0}
    label{font-size:.9rem;color:#cbd5e1;margin-bottom:6px;display:block}
    select,input[type="checkbox"]{width:100%;background:#0b1220;border:1px solid #1f2937;color:var(--text);padding:10px;border-radius:10px;outline:none}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{appearance:none;border:none;background:#ef4444;color:white;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#1f2937;color:#e5e7eb;border:1px solid #273247}
    .btn.ghost{background:transparent;border:1px solid #273247}
    .content{padding:22px}
    .grid{display:grid;gap:16px}
    @media(min-width:1100px){.grid{grid-template-columns:1.2fr .8fr}}
    .cards{display:grid;gap:16px}
    @media(min-width:1400px){.cards{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px}
    .card h3{margin:0 0 6px 0;font-size:1rem}
    .small{font-size:.85rem}
    .gauge{width:100%;max-width:340px;aspect-ratio:1/1;margin:auto;display:block}
    .kpi{display:flex;align-items:center;gap:10px}
    .kpi .pill{font-weight:700;border-radius:999px;padding:4px 10px;border:1px solid #22304a;background:#0b1220}
    .flex{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .toggle{display:flex;align-items:center;gap:10px}
    .toggle input{width:auto}
    .insights{display:grid;gap:12px}
    .insight{background:#0b1220;border:1px dashed #243044;padding:12px;border-radius:12px}
    .footer{display:flex;gap:8px;flex-wrap:wrap}
    .legend{display:flex;gap:10px;flex-wrap:wrap}
    .legend span{display:inline-flex;align-items:center;gap:6px}
    .legend i{display:inline-block;width:12px;height:12px;border-radius:3px;background:#64748b}
    .legend .rom i{background:#3b82f6}
    .legend .mmt i{background:#10b981}
    .legend .norm i{background:#f59e0b}
    .kbd{padding:2px 6px;border:1px solid #2a3a58;border-radius:6px;background:#0b1220;color:#cbd5e1;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:.85rem}
    .status{font-weight:700}
  </style>
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="header">
        <div class="logo">R</div>
        <div>
          <div class="title">ROMetrics</div>
          <div class="muted small">ðŸ“ˆ Performance Hub</div>
        </div>
      </div>

      <div class="bubble" title="This is a Pro feature">
        <span class="dot"></span>
        <strong>Pro Activated</strong>
      </div>

      <div class="sep"></div>

      <label for="jointSelect">Joint / Region</label>
      <select id="jointSelect">
        <option value="shoulder_flexion">Shoulder â€” Flexion</option>
        <option value="shoulder_abduction">Shoulder â€” Abduction</option>
        <option value="knee_flexion">Knee â€” Flexion</option>
        <option value="hip_flexion">Hip â€” Flexion</option>
        <option value="cervical_rotation">Cervical â€” Rotation</option>
      </select>

      <div class="row" style="margin-top:10px">
        <div>
          <label for="windowSelect">Trend Window</label>
          <select id="windowSelect">
            <option value="30">Last 30 days</option>
            <option value="90">Last 90 days</option>
          </select>
        </div>
        <div>
          <label for="sideSelect">Side</label>
          <select id="sideSelect">
            <option value="right">Right</option>
            <option value="left">Left</option>
          </select>
        </div>
      </div>

      <div class="sep"></div>

      <div class="toggle">
        <input id="toggleNorms" type="checkbox" checked>
        <label for="toggleNorms" style="margin:0">Show Normative Overlay</label>
      </div>
      <div class="toggle" style="margin-top:8px">
        <input id="toggleMMT" type="checkbox" checked>
        <label for="toggleMMT" style="margin:0">Show Strength (MMT) Trend</label>
      </div>

      <div class="sep"></div>

      <label for="exportName">Report Title</label>
      <input id="exportName" placeholder="ROMetrics Progress Report" />

      <div class="flex" style="margin-top:10px">
        <button class="btn" id="btnPrint">Export PDF</button>
        <button class="btn secondary" id="btnCSV">Export CSV</button>
        <button class="btn ghost" id="btnReset">Reset Demo Data</button>
      </div>

      <div class="sep"></div>
      <div class="small muted">Tip: Press <span class="kbd">N</span> to toggle norms, <span class="kbd">M</span> to toggle MMT, <span class="kbd">P</span> to Print.</div>

      <div class="sep"></div>
      <div class="small muted">This standalone page can be dropped into <code>/performance-hub/index.html</code> in your GitHub Pages repo.
        To wire live data, call <code>window.ROMetrics.setData(...)</code> from your app after auth.
      </div>
    </aside>

    <main class="content">
      <section class="grid">
        <div class="cards">
          <div class="card">
            <h3>Recovery Score</h3>
            <div class="muted small">Weighted average of ROM Ã— MMT Ã— consistency</div>
            <svg class="gauge" viewBox="0 0 100 100" id="recoveryGauge" aria-label="Recovery Score Gauge"></svg>
            <div class="kpi" style="justify-content:center;margin-top:8px">
              <span class="pill"><span class="muted">Score</span> <span id="scoreVal">â€”</span></span>
              <span class="pill"><span class="muted">ROM%</span> <span id="romVal">â€”</span></span>
              <span class="pill"><span class="muted">MMT%</span> <span id="mmtVal">â€”</span></span>
              <span class="pill"><span class="muted">Consistency</span> <span id="consVal">â€”</span></span>
            </div>
          </div>

          <div class="card">
            <h3>Trend â€” Range of Motion</h3>
            <div class="legend">
              <span class="rom"><i></i>ROM</span>
              <span class="norm"><i></i>Norm</span>
            </div>
            <canvas id="romChart" height="220"></canvas>
          </div>

          <div class="card">
            <h3>Trend â€” Strength (MMT)</h3>
            <div class="legend">
              <span class="mmt"><i></i>MMT</span>
              <span class="norm"><i></i>Norm</span>
            </div>
            <canvas id="mmtChart" height="220"></canvas>
          </div>
        </div>

        <div class="card" style="align-self:start">
          <h3>AI Insight Tiles</h3>
          <div class="muted small">Auto-generated observations about your last 30â€“90 days</div>
          <div class="insights" id="insights"></div>
          <div class="sep"></div>
          <div class="footer">
            <button class="btn" id="btnRefreshInsights">Refresh Insights</button>
            <button class="btn secondary" id="btnMarkGoal">Mark Goal Reached</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ---------------------------
    // Minimal state & demo data
    // ---------------------------
    const state = {
      windowDays: 30,
      joint: 'shoulder_flexion',
      side: 'right',
      showNorms: true,
      showMMT: true,
      // Norms: expected ROM degrees by joint (simplified, demo values)
      norms: {
        shoulder_flexion: 180, shoulder_abduction: 180, knee_flexion: 135, hip_flexion: 120, cervical_rotation: 80
      },
      // Demo series (days ago, value)
      data: demoSeries(90, 120, 180), // ROM
      mmt: demoSeries(90, 3.5, 5),    // MMT 0-5
      sessions: demoSessions(90)      // boolean per day if user tested that day
    };

    function demoSeries(days, min, max){
      const arr = [];
      const now = new Date();
      for (let i=days-1;i>=0;i--){
        const d = new Date(now); d.setDate(d.getDate()-i);
        const jitter = (Math.sin(i/4)+Math.random()*0.6-0.3)*((max-min)/12);
        const base = min + (max-min)*(.4 + .5*Math.random());
        arr.push({date:d, value: Math.max(min, Math.min(max, base + jitter))});
      }
      return arr;
    }
    function demoSessions(days){
      const arr = [];
      for (let i=0;i<days;i++){ arr.push(Math.random()>.33); }
      return arr;
    }

    // ---------------------------
    // Charts setup
    // ---------------------------
    const romCtx = document.getElementById('romChart');
    const mmtCtx = document.getElementById('mmtChart');
    let romChart, mmtChart;

    function buildCharts(){
      const {labels, romVals, normVals, mmtVals, normMMT} = getWindowedSeries();
      if(romChart) romChart.destroy();
      romChart = new Chart(romCtx, {
        type:'line',
        data:{
          labels,
          datasets:[
            {label:'ROM', data:romVals, tension:.35, borderWidth:2, pointRadius:0, borderColor:'#3b82f6'},
            state.showNorms ? {label:'Norm', data:normVals, tension:0, borderDash:[6,6], borderWidth:2, pointRadius:0, borderColor:'#f59e0b'} : null
          ].filter(Boolean)
        },
        options:baseLineOptions('%')
      });

      if(mmtChart) mmtChart.destroy();
      mmtChart = new Chart(mmtCtx, {
        type:'line',
        data:{
          labels,
          datasets:[
            state.showMMT ? {label:'MMT', data:mmtVals, tension:.35, borderWidth:2, pointRadius:0, borderColor:'#10b981'} : null,
            state.showNorms ? {label:'Norm', data:normMMT, tension:0, borderDash:[6,6], borderWidth:2, pointRadius:0, borderColor:'#f59e0b'} : null
          ].filter(Boolean)
        },
        options:baseLineOptions('')
      });
    }

    function baseLineOptions(suffix){
      return {
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          x:{grid:{color:'#1f2937'}, ticks:{color:'#9ca3af', autoSkip:true, maxTicksLimit:6}},
          y:{grid:{color:'#1f2937'}, ticks:{color:'#9ca3af', callback:(v)=> v + (suffix||'')}}
        },
        plugins:{legend:{labels:{color:'#cbd5e1'}}}
      }
    }

    function getWindowedSeries(){
      const days = state.windowDays;
      const rom = state.data.slice(-days);
      const mmt = state.mmt.slice(-days);
      const labels = rom.map(d => fmtDate(d.date));
      const normDeg = state.norms[state.joint] || 100;
      const romVals = rom.map(d => Math.round((d.value/normDeg)*100));
      const normVals = rom.map(_ => 100);
      const mmtVals = mmt.map(d => Math.round((d.value/5)*100));
      const normMMT = mmt.map(_ => 100);
      return {labels, romVals, normVals, mmtVals, normMMT};
    }

    function fmtDate(d){ return d.toLocaleDateString(undefined,{month:'short', day:'numeric'}) }

    // ---------------------------
    // Gauge (SVG)
    // ---------------------------
    function renderGauge(score){
      const svg = document.getElementById('recoveryGauge');
      svg.innerHTML = '';
      const cx=50, cy=50, r=42, circ=2*Math.PI*r;
      const bg = document.createElementNS('http://www.w3.org/2000/svg','circle');
      bg.setAttribute('cx',cx); bg.setAttribute('cy',cy); bg.setAttribute('r',r); bg.setAttribute('fill','none'); bg.setAttribute('stroke','#1f2937'); bg.setAttribute('stroke-width','12');
      svg.appendChild(bg);
      const fg = document.createElementNS('http://www.w3.org/2000/svg','circle');
      fg.setAttribute('cx',cx); fg.setAttribute('cy',cy); fg.setAttribute('r',r); fg.setAttribute('fill','none'); fg.setAttribute('stroke', gaugeColor(score)); fg.setAttribute('stroke-width','12'); fg.setAttribute('stroke-linecap','round');
      fg.setAttribute('stroke-dasharray',circ.toFixed(2));
      fg.setAttribute('stroke-dashoffset', ((1 - score/100) * circ).toFixed(2));
      svg.appendChild(fg);
      const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
      txt.setAttribute('x',cx); txt.setAttribute('y',cy+4); txt.setAttribute('text-anchor','middle'); txt.setAttribute('font-size','20'); txt.setAttribute('font-weight','800'); txt.textContent = Math.round(score) + '%';
      svg.appendChild(txt);
      const sub = document.createElementNS('http://www.w3.org/2000/svg','text');
      sub.setAttribute('x',cx); sub.setAttribute('y',cy+22); sub.setAttribute('text-anchor','middle'); sub.setAttribute('font-size','8'); sub.setAttribute('fill','#9ca3af'); sub.textContent = 'Recovery Score';
      svg.appendChild(sub);
    }
    function gaugeColor(s){ if(s>=90) return '#16a34a'; if(s>=70) return '#f59e0b'; return '#ef4444'; }

    // ---------------------------
    // Recovery Score computation
    // ---------------------------
    function computeScore(){
      const {romVals, mmtVals} = getWindowedSeries();
      const rom = avg(romVals);
      const mmt = avg(mmtVals);
      const consistency = computeConsistency();
      // weights: ROM .4, MMT .4, consistency .2
      const score = rom*.4 + mmt*.4 + consistency*.2;
      renderGauge(score);
      document.getElementById('scoreVal').textContent = Math.round(score)+'%';
      document.getElementById('romVal').textContent = Math.round(rom)+'%';
      document.getElementById('mmtVal').textContent = Math.round(mmt)+'%';
      document.getElementById('consVal').textContent = Math.round(consistency)+'%';
    }

    function computeConsistency(){
      const days = state.windowDays;
      const recent = state.sessions.slice(-days);
      const adherence = recent.filter(Boolean).length / recent.length; // 0..1
      // Full credit if >= 4 sessions/week average for 30 days â‰ˆ 17/30
      const target = Math.min(1, adherence / (17/30));
      return Math.round(target*100);
    }

    const avg = arr => arr.reduce((a,b)=>a+b,0)/Math.max(1,arr.length);

    // ---------------------------
    // Insights
    // ---------------------------
    function refreshInsights(){
      const box = document.getElementById('insights');
      box.innerHTML = '';
      const {romVals, mmtVals} = getWindowedSeries();
      const deltaROM = trendDelta(romVals);
      const deltaMMT = trendDelta(mmtVals);
      const consistency = computeConsistency();

      addInsight(box, `ROM ${deltaROM>=0? 'improving':'declining'} ${Math.abs(deltaROM)}% over the last ${state.windowDays} days.`);
      addInsight(box, `Strength ${deltaMMT>=0? 'up':'down'} ${Math.abs(deltaMMT)}% in the same period.`);
      if(consistency>=90) addInsight(box, `Excellent adherence â€” ${consistency}% of days logged. Keep the streak!`);
      else if(consistency>=70) addInsight(box, `Solid consistency â€” ${consistency}% of days logged. Aim for â‰¥4 sessions/week.`);
      else addInsight(box, `Low adherence â€” only ${consistency}% of days logged. Schedule reminders to improve results.`);

      const romAvg = Math.round(avg(romVals));
      if(romAvg<70) addInsight(box, `Flexibility Index low (${romAvg}%). Try the hip and shoulder mobility series.`);
      else if(romAvg<85) addInsight(box, `ROM is moderate (${romAvg}%). Consider adding dynamic warm-ups before testing.`);
      else addInsight(box, `ROM is strong (${romAvg}%). Maintain with light mobility 3x/week.`);
    }

    function trendDelta(vals){
      if(vals.length<2) return 0;
      const first = avg(vals.slice(0, Math.ceil(vals.length/3)));
      const last = avg(vals.slice(Math.floor(vals.length*2/3)));
      return Math.round(last - first);
    }

    function addInsight(box, text){
      const el = document.createElement('div');
      el.className = 'insight';
      el.textContent = text;
      box.appendChild(el);
    }

    // ---------------------------
    // Export
    // ---------------------------
    document.getElementById('btnPrint').addEventListener('click', ()=>{
      const title = document.getElementById('exportName').value || 'ROMetrics Progress Report';
      document.title = title;
      window.print();
    });

    document.getElementById('btnCSV').addEventListener('click', ()=>{
      const {labels, romVals, mmtVals} = getWindowedSeries();
      const rows = [['Date','ROM_%','MMT_%']].concat(labels.map((d,i)=>[d,romVals[i],mmtVals[i]]));
      const csv = rows.map(r=>r.join(',')).join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
      a.download = 'rometrics_performance.csv';
      a.click();
    });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      state.data = demoSeries(90, 120, 180);
      state.mmt = demoSeries(90, 3.5, 5);
      state.sessions = demoSessions(90);
      buildCharts();
      computeScore();
      refreshInsights();
    });

    document.getElementById('btnRefreshInsights').addEventListener('click', refreshInsights);
    document.getElementById('btnMarkGoal').addEventListener('click', ()=>{
      addInsight(document.getElementById('insights'), 'âœ… Goal marked as reached. Great job!');
    });

    // ---------------------------
    // Controls
    // ---------------------------
    document.getElementById('jointSelect').addEventListener('change', (e)=>{
      state.joint = e.target.value; buildCharts(); computeScore(); refreshInsights();
    });
    document.getElementById('windowSelect').addEventListener('change', (e)=>{
      state.windowDays = parseInt(e.target.value,10); buildCharts(); computeScore(); refreshInsights();
    });
    document.getElementById('sideSelect').addEventListener('change', (e)=>{
      state.side = e.target.value; /* placeholder for future L/R split */ buildCharts(); computeScore(); refreshInsights();
    });
    document.getElementById('toggleNorms').addEventListener('change', (e)=>{ state.showNorms = e.target.checked; buildCharts(); });
    document.getElementById('toggleMMT').addEventListener('change', (e)=>{ state.showMMT   = e.target.checked; buildCharts(); });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(e.key==='n' || e.key==='N'){ const t=document.getElementById('toggleNorms'); t.checked=!t.checked; t.dispatchEvent(new Event('change')); }
      if(e.key==='m' || e.key==='M'){ const t=document.getElementById('toggleMMT'); t.checked=!t.checked; t.dispatchEvent(new Event('change')); }
      if(e.key==='p' || e.key==='P'){ document.getElementById('btnPrint').click(); }
    });

    // ---------------------------
    // Public hook for real data wiring
    // ---------------------------
    window.ROMetrics = window.ROMetrics || {};
    /**
     * Inject real series from your app after auth.
     * @param {Object} cfg
     * @param {Array<{date:Date|number|string,value:number}>} cfg.rom - absolute ROM degrees per day
     * @param {Array<{date:Date|number|string,value:number}>} cfg.mmt - MMT 0..5 per day
     * @param {Array<boolean>} cfg.sessions - adherence booleans per day
     * @param {number} [cfg.normDeg] - override normative degrees for current joint
     */
    window.ROMetrics.setData = function(cfg={}){
      if(cfg.rom){ state.data = cfg.rom.map(x=>({date:new Date(x.date), value:x.value})) }
      if(cfg.mmt){ state.mmt = cfg.mmt.map(x=>({date:new Date(x.date), value:x.value})) }
      if(cfg.sessions){ state.sessions = cfg.sessions.slice(-90) }
      if(cfg.normDeg){ state.norms[state.joint] = cfg.normDeg }
      buildCharts(); computeScore(); refreshInsights();
    }

    // Initial render
    buildCharts();
    computeScore();
    refreshInsights();
  </script>
</body>
</html>
