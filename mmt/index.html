<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ROMetrics — Manual Muscle Testing (MMT)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0f14;--card:rgba(255,255,255,.88);--ink:#0f172a;}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:#111}
.bg{position:fixed;inset:0;background:#0b0f14 url('./assets/bg_pt_office.jpg') center/cover no-repeat;filter:saturate(1.05) brightness(.9)}
.overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(11,15,20,.25),rgba(11,15,20,.6))}

/* Layout: big left stage, tiny right controls */
.wrap{position:relative;display:grid;grid-template-columns:1fr auto;gap:16px;max-width:1200px;margin:32px auto;padding:12px}
.card{backdrop-filter:blur(10px);background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
.header{padding:14px 16px;border-bottom:1px solid rgba(0,0,0,.06);display:flex;align-items:center;justify-content:space-between}
.title{font-weight:700}
.muted{color:#1f2937;opacity:.75}
.panel{padding:14px 16px}

/* Stage (left) */
.stage{height:min(65vh,520px);display:flex;align-items:center;justify-content:center}
#stageModel{width:100%;height:100%}

/* Compact controls (right) */
.controls{width:280px}
.controls .panel{display:grid;gap:10px}
.select, .search{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.08);font-size:14px;background:#fff}
.small{font-size:12px;color:#475569}

/* Floating detail panel */
.floating{position:fixed;left:24px;top:24px;width:min(520px,92vw);max-height:85vh;overflow:auto;z-index:50;user-select:none}
.floating .header{cursor:move}
.floating.pinned .header{cursor:grab}
.hidden{display:none}
.footer{padding:10px 14px;color:#0b0f14;opacity:.9;text-align:center;font-size:12px;border-top:1px solid rgba(0,0,0,.06)}

/* Buttons */
.row{display:flex;gap:8px;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(0,0,0,.08);background:#fff;border-radius:999px;padding:8px 12px;font-weight:600;cursor:pointer}
.pill[data-active="true"]{background:var(--ink);color:#fff;border-color:transparent}

@media(max-width:960px){
  .wrap{grid-template-columns:1fr}
  .controls{width:auto}
}
</style>
<script type="module" src="https://unpkg.com/@google/model-viewer@3.5.0/dist/model-viewer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div class="bg"></div><div class="overlay"></div>

<main class="wrap">
  <!-- Left: 3D stage -->
  <section class="card stage" aria-label="3D stage">
    <model-viewer id="stageModel" exposure="1" camera-controls auto-rotate autoplay
      reveal="interaction" ar-status="not-presenting" style="display:none"></model-viewer>
  </section>

  <!-- Right: ultra-compact controls -->
  <aside class="card controls" aria-label="MMT controls">
    <div class="header">
      <div>
        <div class="title">ROMetrics — MMT</div>
        <div class="muted small">Tiny picker • details float</div>
      </div>
    </div>
    <div class="panel">
      <select id="scope" class="select" aria-label="Region">
        <option value="all" selected>All regions</option>
        <option value="upper">Upper body</option>
        <option value="lower">Lower body</option>
      </select>
      <input id="q" class="search" placeholder="Search test…" />
      <select id="test" class="select" size="6" aria-label="Tests"></select>
      <div class="small">Tip: Click a test to open the floating panel. Click the panel header to lock/unlock.</div>
    </div>
  </aside>

  <!-- Floating details panel (follows cursor when unpinned) -->
  <aside id="detail" class="card floating hidden" role="dialog" aria-modal="false" aria-labelledby="detailTitle">
    <div class="header" id="dragHandle">
      <div class="title" id="detailTitle">Test Details</div>
      <div class="row">
        <button id="pinBtn" class="pill" aria-pressed="false" title="Pin to lock position">Pin</button>
        <button id="closeBtn" class="pill" title="Close">✕</button>
      </div>
    </div>
    <div id="md" class="panel"><div class="muted">Loading test library…</div><div id="accordion"></div></div>
    <div class="footer">Always test mid-range • Apply resistance gradually (~3 s)</div>
  </aside>
</main>

<script>
/* ---------- Load MD (Pages path -> raw fallback) ---------- */
const OWNER='Kingto89', REPO='ROMetrics';
const PAGES_MD=`/${REPO}/mmt/rometrics_mmt_library.md?cache=${Date.now()}`;
const RAW_MD=`https://raw.githubusercontent.com/${OWNER}/${REPO}/main/mmt/rometrics_mmt_library.md?cache=${Date.now()}`;
let SECTIONS=[], selectedId=null;

(async function loadMD(){
  try{
    let r=await fetch(PAGES_MD); if(!r.ok) r=await fetch(RAW_MD);
    const text=await r.text(); parseAndRender(text);
  }catch(e){ document.getElementById('md').innerHTML='<div class="panel">Error loading library.</div>'; }
})();

function parseAndRender(t){
  const lines=t.split(/\n/), map=[]; let scope='upper';
  for(let i=0;i<lines.length;i++){
    if(/^##\s+Upper/i.test(lines[i])) scope='upper';
    if(/^##\s+Lower/i.test(lines[i])) scope='lower';
    if(/^###\s+/.test(lines[i])) map.push({idx:i,scope});
  }
  SECTIONS=[];
  for(let j=0;j<map.length;j++){
    const start=map[j].idx, end=(map[j+1]?map[j+1].idx:lines.length);
    const block=lines.slice(start,end).join('\n');
    const m=block.match(/^###\s+(.+)$/m); if(!m) continue;
    const id=m[1].toLowerCase().replace(/[^a-z0-9]+/g,'-');
    SECTIONS.push({id,scope:map[j].scope,title:m[1],html:marked.parse(block)});
  }
  rebuildTestList();
}

/* ---------- Compact picker logic ---------- */
const scopeSel=document.getElementById('scope');
const qInput=document.getElementById('q');
const testSel=document.getElementById('test');

function rebuildTestList(){
  const scope=scopeSel.value, q=(qInput.value||'').toLowerCase();
  const items=SECTIONS.filter(s=>(scope==='all'||s.scope===scope)&&(!q||s.title.toLowerCase().includes(q)));
  testSel.innerHTML = items.map(s=>`<option value="${s.id}">${s.title}</option>`).join('');
}

scopeSel.addEventListener('change', rebuildTestList);
qInput.addEventListener('input', rebuildTestList);

testSel.addEventListener('change', ()=>{
  const id=testSel.value;
  if(!id) return;
  openTest(id);
});
testSel.addEventListener('dblclick', ()=>{ if(testSel.value) openTest(testSel.value); });

function openTest(id){
  selectedId=id;
  const s=SECTIONS.find(x=>x.id===id); if(!s) return;
  document.getElementById('accordion').innerHTML=s.html;
  openDetail(); // floating panel
}

/* ---------- Floating panel behavior ---------- */
const panel=document.getElementById('detail');
const handle=document.getElementById('dragHandle');
const closeBtn=document.getElementById('closeBtn');
const pinBtn=document.getElementById('pinBtn');

let pinned=false;              // when false -> panel follows cursor
let drag=false, moved=false;   // manual drag only when pinned
let sx=0, sy=0, sl=0, st=0;
const FOLLOW_OFFSET={x:18,y:18};

function setPinned(val){
  pinned=!!val;
  panel.classList.toggle('pinned', pinned);
  pinBtn.textContent=pinned?'Unpin':'Pin';
  pinBtn.setAttribute('aria-pressed', String(pinned));
}

function openDetail(){
  panel.classList.remove('hidden');
  // If unpinned, start following immediately (no click required)
}
function closeDetail(){
  panel.classList.add('hidden');
  selectedId=null;
}

closeBtn.onclick=closeDetail;
pinBtn.onclick=()=>setPinned(!pinned);

/* Follow-cursor mode when UNPINNED */
document.addEventListener('pointermove', (e)=>{
  if(panel.classList.contains('hidden')) return;
  if(pinned) return;
  const x=Math.min(Math.max(10, e.clientX + FOLLOW_OFFSET.x), window.innerWidth - panel.offsetWidth - 10);
  const y=Math.min(Math.max(10, e.clientY + FOLLOW_OFFSET.y), window.innerHeight - panel.offsetHeight - 10);
  panel.style.left = x + 'px';
  panel.style.top  = y + 'px';
});

/* Click header toggles pin/unpin (and stops following instantly) */
handle.addEventListener('click', (e)=>{
  if(e.target.closest('button')) return; // ignore clicks on buttons
  if(moved){ moved=false; return; }      // ignore click after a drag
  setPinned(!pinned);
});

/* While PINNED, allow precise drag with the header */
handle.addEventListener('pointerdown', (e)=>{
  if(e.button!==0) return;
  if(!pinned) return; // only drag when pinned
  moved=false; drag=true; sx=e.clientX; sy=e.clientY;
  const r=panel.getBoundingClientRect(); sl=r.left; st=r.top;
  panel.setPointerCapture(e.pointerId);
});
handle.addEventListener('pointermove', (e)=>{
  if(!drag) return;
  const dx=e.clientX-sx, dy=e.clientY-sy;
  if(Math.abs(dx)>2 || Math.abs(dy)>2) moved=true;
  panel.style.left=Math.min(Math.max(10, sl+dx), window.innerWidth - panel.offsetWidth - 10)+'px';
  panel.style.top =Math.min(Math.max(10, st+dy), window.innerHeight - panel.offsetHeight - 10)+'px';
});
handle.addEventListener('pointerup', (e)=>{
  if(drag){ try{ panel.releasePointerCapture(e.pointerId) }catch{} }
  drag=false;
});
handle.addEventListener('pointercancel', ()=>{ drag=false; });

/* Keyboard shortcut: P = pin/unpin; Esc = close (only if unpinned) */
document.addEventListener('keydown', (e)=>{
  if(e.key.toLowerCase()==='p') setPinned(!pinned);
  if(e.key==='Escape' && !pinned) closeDetail();
});

/* ---------- Optional: auto-load stick model if present ---------- */
(async function loadStageModel(){
  const el=document.getElementById('stageModel');
  const candidates = [
    '/ROMetrics/goniometry-trainer/assets/stick.glb',
    '/ROMetrics/goniometry-trainer/stick.glb',
    './assets/stick.glb'
  ];
  for(const url of candidates){
    try{
      const res = await fetch(url, { method:'HEAD' });
      if(res.ok){ el.src = url; el.style.display='block'; return; }
    }catch(_){}
  }
})();
</script>
</body>
</html>
