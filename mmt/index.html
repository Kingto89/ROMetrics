<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ROMetrics — Manual Muscle Testing (MMT)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0f14;--card:rgba(255,255,255,.88);--ink:#0f172a;}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:#111}
.bg{position:fixed;inset:0;background:#0b0f14 url('./assets/bg_pt_office.jpg') center/cover no-repeat;
filter:saturate(1.05) brightness(.9);}
.overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(11,15,20,.25),rgba(11,15,20,.6));}
.wrap{position:relative;display:grid;grid-template-columns:1.2fr 1fr;gap:20px;max-width:1100px;margin:40px auto;padding:16px}
@media(max-width:980px){.wrap{grid-template-columns:1fr}}
.card{backdrop-filter:blur(10px);background:var(--card);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
.header{padding:18px 20px;border-bottom:1px solid rgba(0,0,0,.06);display:flex;align-items:center;justify-content:space-between}
.title{font-weight:700}
.muted{color:#1f2937;opacity:.75}
.panel{padding:16px 18px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(0,0,0,.08);background:white;
border-radius:999px;padding:8px 12px;font-weight:600;cursor:pointer}
.pill[data-active="true"]{background:var(--ink);color:white;border-color:transparent}
.search{width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(0,0,0,.08);font-size:14px}
.list{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
@media(max-width:980px){.list{grid-template-columns:1fr}}
.item{background:white;border:1px solid rgba(0,0,0,.08);border-radius:12px;padding:12px;display:flex;
flex-direction:column;gap:6px;transition:all .15s}
.item h4{margin:0;font-size:15px}
.item small{color:#475569}
.item[data-active="true"]{outline:2px solid #1d4ed8;background:#eef2ff}

/* Right column stage (pure 3D area) */
.stage{height:360px;display:flex;align-items:center;justify-content:center}
#stageModel{width:100%;height:100%}

.footer{padding:12px 18px;color:white;opacity:.9;text-align:center;font-size:12px}

/* Floating panel */
.floating{position:fixed;right:20px;top:20px;width:min(520px,92vw);max-height:85vh;overflow:auto;z-index:50}
.floating .header{cursor:grab;-webkit-user-select:none;user-select:none}
.floating[data-dragging="true"] .header{cursor:grabbing}
.hidden{display:none}
</style>
<script type="module" src="https://unpkg.com/@google/model-viewer@3.5.0/dist/model-viewer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div class="bg"></div><div class="overlay"></div>

<main class="wrap">
  <!-- Left column -->
  <section class="card">
    <div class="header">
      <div>
        <div class="title">ROMetrics — MMT Lab</div>
        <div class="muted">Interactive manual muscle testing space</div>
      </div>
    </div>
    <div class="panel">
      <input id="q" class="search" placeholder="Search tests… (e.g., shoulder flexion, hip abduction)">
      <div class="row" style="margin-top:10px">
        <button class="pill" data-scope="all" data-active="true">All</button>
        <button class="pill" data-scope="upper">Upper Body</button>
        <button class="pill" data-scope="lower">Lower Body</button>
      </div>
      <div id="grid" class="list" aria-live="polite"></div>
    </div>
  </section>

  <!-- Right column: 3D stage (blank by default; loads stick model if found) -->
  <section class="card stage" aria-label="3D stage">
    <model-viewer id="stageModel" exposure="1" camera-controls auto-rotate autoplay
      reveal="interaction" ar-status="not-presenting" style="display:none"></model-viewer>
  </section>

  <!-- Floating details panel -->
  <aside id="detail" class="card floating hidden" role="dialog" aria-modal="false" aria-labelledby="detailTitle">
    <div class="header" id="dragHandle">
      <div class="title" id="detailTitle">Test Details</div>
      <div class="row"><button id="pinBtn" class="pill">Pin</button><button id="closeBtn" class="pill">✕</button></div>
    </div>
    <div id="md" class="panel"><div class="muted">Loading test library…</div><div id="accordion"></div></div>
    <div class="footer">Always test in <strong>mid-range</strong>. Apply resistance gradually (~3 s).</div>
  </aside>
</main>

<script>
/* ------------ Load MD (Pages path -> raw fallback) ------------- */
const OWNER='Kingto89', REPO='ROMetrics';
const PAGES_MD=`/${REPO}/mmt/rometrics_mmt_library.md?cache=${Date.now()}`;
const RAW_MD=`https://raw.githubusercontent.com/${OWNER}/${REPO}/main/mmt/rometrics_mmt_library.md?cache=${Date.now()}`;
let sections=[], selectedId=null;

(async function loadMD(){
  try{
    let r=await fetch(PAGES_MD); if(!r.ok) r=await fetch(RAW_MD);
    const text=await r.text(); parseAndRender(text);
  }catch(e){ document.getElementById('md').innerHTML='<div class="panel">Error loading library.</div>'; }
})();

function parseAndRender(t){
  const lines=t.split(/\n/), map=[]; let scope='upper';
  for(let i=0;i<lines.length;i++){
    if(/^##\s+Upper/i.test(lines[i])) scope='upper';
    if(/^##\s+Lower/i.test(lines[i])) scope='lower';
    if(/^###\s+/.test(lines[i])) map.push({idx:i,scope});
  }
  sections=[];
  for(let j=0;j<map.length;j++){
    const start=map[j].idx, end=(map[j+1]?map[j+1].idx:lines.length);
    const block=lines.slice(start,end).join('\n');
    const m=block.match(/^###\s+(.+)$/m); if(!m) continue;
    const id=m[1].toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$|--+/g,'-');
    sections.push({id,scope:map[j].scope,title:m[1],html:marked.parse(block)});
  }
  renderGrid();
}

/* ------------ Grid & selection (no 'No tests' message) ---------- */
function renderGrid(filter='all', q=''){
  const grid=document.getElementById('grid'); const qq=(q||'').toLowerCase();
  const items=sections.filter(s=>(filter==='all'||s.scope===filter)&&(!qq||s.title.toLowerCase().includes(qq)));
  grid.innerHTML = items.map(s=>(
    `<button class="item" data-id="${s.id}" ${selectedId===s.id?'data-active="true"':''}>
       <h4>${s.title}</h4><small>${s.scope==='upper'?'Upper body':'Lower body'}</small>
     </button>`
  )).join('');
}

function selectTest(id){
  selectedId=id; renderGrid(currentScope(), document.getElementById('q').value||'');
  const s=sections.find(x=>x.id===id); if(!s) return;
  document.getElementById('accordion').innerHTML=s.html;
  openDetail();
}

function currentScope(){ const a=document.querySelector('.pill[data-active="true"]'); return a?a.dataset.scope:'all'; }

/* ------------ UI wiring ------------- */
document.addEventListener('click',e=>{
  const pill=e.target.closest('.pill');
  if(pill && !pill.id){
    document.querySelectorAll('.pill[data-scope]').forEach(b=>b.dataset.active=false);
    pill.dataset.active=true; renderGrid(pill.dataset.scope, document.getElementById('q').value||''); return;
  }
  const item=e.target.closest('.item'); if(item) selectTest(item.dataset.id);
});
document.getElementById('q').addEventListener('input',e=>renderGrid(currentScope(),e.target.value));
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeDetail(); });

/* ------------ Floating panel: open/close/pin ------------- */
const panel=document.getElementById('detail'), closeBtn=document.getElementById('closeBtn'), pinBtn=document.getElementById('pinBtn');
let pinned=false;
function openDetail(){ panel.classList.remove('hidden'); }
function closeDetail(){ if(!pinned){ panel.classList.add('hidden'); selectedId=null; renderGrid(currentScope(), document.getElementById('q').value||''); } }
closeBtn.onclick=closeDetail; pinBtn.onclick=()=>{ pinned=!pinned; pinBtn.textContent=pinned?'Pinned':'Pin'; };

/* ------------ DRAG: stable, releases even if pointer leaves header ---------- */
const handle=document.getElementById('dragHandle');
let dragging=false, startX=0, startY=0, startLeft=0, startTop=0, activeId=null;

function ensureLeftTop(){
  if(getComputedStyle(panel).right!=='auto'){
    const r=panel.getBoundingClientRect();
    panel.style.left=r.left+'px';
    panel.style.top=r.top+'px';
    panel.style.right='auto';
  }
}

function onPointerDown(e){
  if (e.target.closest('button')) return;       // ignore clicks on pin/close
  if (e.button !== 0) return;                   // left click only
  ensureLeftTop();
  dragging=true; activeId=e.pointerId;
  panel.dataset.dragging='true';
  startX=e.clientX; startY=e.clientY;
  const r=panel.getBoundingClientRect(); startLeft=r.left; startTop=r.top;
  panel.setPointerCapture(activeId);
  e.preventDefault();
}

function onPointerMove(e){
  if(!dragging || e.pointerId!==activeId) return;
  const dx=e.clientX-startX, dy=e.clientY-startY;
  const pad=10;
  const maxLeft=window.innerWidth-panel.offsetWidth-pad;
  const maxTop=window.innerHeight-panel.offsetHeight-pad;
  const newLeft=Math.min(Math.max(startLeft+dx,pad), Math.max(maxLeft,pad));
  const newTop=Math.min(Math.max(startTop+dy,pad), Math.max(maxTop,pad));
  panel.style.left=newLeft+'px';
  panel.style.top=newTop+'px';
}

function endDrag(){
  if(!dragging) return;
  dragging=false;
  panel.dataset.dragging='false';
  try{ if(activeId!==null) panel.releasePointerCapture(activeId); }catch{}
  activeId=null;
}

handle.addEventListener('pointerdown', onPointerDown);
handle.addEventListener('pointermove', onPointerMove);
handle.addEventListener('pointerup', endDrag);
handle.addEventListener('pointercancel', endDrag);
window.addEventListener('pointerup', endDrag); // safety: end drag even outside the header

/* ------------ Optional: auto-load stick model if present -------- */
(async function loadStageModel(){
  const el=document.getElementById('stageModel');
  const candidates=[
    '/ROMetrics/goniometry-trainer/assets/stick.glb',
    '/ROMetrics/goniometry-trainer/stick.glb',
    './assets/stick.glb'
  ];
  for(const url of candidates){
    try{
      const res=await fetch(url,{method:'HEAD'});
      if(res.ok){ el.src=url; el.style.display='block'; return; }
    }catch(_){}
  }
  // If nothing found: stage stays blank.
})();
</script>
</body>
</html>
