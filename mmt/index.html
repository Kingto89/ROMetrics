<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ROMetrics — Manual Muscle Testing (MMT)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0f14;--card:rgba(255,255,255,.88);--ink:#0f172a;}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:#111}
.bg{position:fixed;inset:0;background:#0b0f14 url('./assets/bg_pt_office.jpg') center/cover no-repeat;filter:saturate(1.05) brightness(.9)}
.overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(11,15,20,.25),rgba(11,15,20,.6))}

/* Layout: big left stage, compact right controls */
.wrap{position:relative;display:grid;grid-template-columns:1fr auto;gap:16px;max-width:1200px;margin:32px auto;padding:12px}
.card{backdrop-filter:blur(10px);background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
.header{padding:14px 16px;border-bottom:1px solid rgba(0,0,0,.06);display:flex;align-items:center;justify-content:space-between}
.title{font-weight:700}
.muted{color:#1f2937;opacity:.75}
.panel{padding:14px 16px}

/* Stage (left) */
.stage{height:min(65vh,520px);display:flex;align-items:center;justify-content:center}
#stageModel{width:100%;height:100%}

/* Compact controls (right) */
.controls{width:280px}
.controls .panel{display:grid;gap:10px; position:relative;} /* relative to place overlay */
.select, .search{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.08);font-size:14px;background:#fff}
.small{font-size:12px;color:#475569}

/* In-card detail overlay (same width as controls panel) */
.detail-overlay{position:absolute; inset:0; z-index:5; background:#ffffff; border:1px solid rgba(0,0,0,.08);
  border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.25); display:none; overflow:auto; }
.detail-overlay.open{display:block;}
.detail-header{position:sticky;top:0;background:#fff;border-bottom:1px solid rgba(0,0,0,.06);
  display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px}
.detail-title{font-weight:700}
.detail-body{padding:14px}
.detail-footer{padding:10px 14px;color:#0b0f14;opacity:.9;text-align:center;font-size:12px;border-top:1px solid rgba(0,0,0,.06)}
.pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(0,0,0,.08);background:#fff;border-radius:999px;padding:8px 12px;font-weight:600;cursor:pointer}

@media(max-width:960px){
  .wrap{grid-template-columns:1fr}
  .controls{width:auto}
}
</style>
<script type="module" src="https://unpkg.com/@google/model-viewer@3.5.0/dist/model-viewer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div class="bg"></div><div class="overlay"></div>

<main class="wrap">
  <!-- Left: 3D stage -->
  <section class="card stage" aria-label="3D stage">
    <model-viewer id="stageModel" exposure="1" camera-controls auto-rotate autoplay
      reveal="interaction" ar-status="not-presenting" style="display:none"></model-viewer>
  </section>

  <!-- Right: compact controls -->
  <aside class="card controls" aria-label="MMT controls">
    <div class="header">
      <div>
        <div class="title">ROMetrics — MMT</div>
        <div class="muted small">Select a region & test</div>
      </div>
    </div>
    <div class="panel" id="controlsPanel">
      <select id="scope" class="select" aria-label="Region">
        <option value="all" selected>All regions</option>
        <option value="upper">Upper body</option>
        <option value="lower">Lower body</option>
      </select>
      <input id="q" class="search" placeholder="Search test…" />
      <select id="test" class="select" size="8" aria-label="Tests"></select>
      <div class="small">Pick a test to open details. Press Esc to close.</div>

      <!-- Details overlay lives INSIDE this panel; same width, no floating -->
      <div id="detail" class="detail-overlay" role="dialog" aria-modal="false" aria-labelledby="detailTitle">
        <div class="detail-header">
          <div class="detail-title" id="detailTitle">Test Details</div>
          <button id="closeBtn" class="pill" title="Close">✕</button>
        </div>
        <div id="md" class="detail-body">
          <div class="muted">Loading test library…</div>
          <div id="accordion"></div>
        </div>
        <div class="detail-footer">Always test in <strong>mid-range</strong>. Apply resistance gradually (~3 s).</div>
      </div>
    </div>
  </aside>
</main>

<script>
/* ---------- Load MD (Pages path -> raw fallback) ---------- */
const OWNER='Kingto89', REPO='ROMetrics';
const PAGES_MD=`/${REPO}/mmt/rometrics_mmt_library.md?cache=${Date.now()}`;
const RAW_MD=`https://raw.githubusercontent.com/${OWNER}/${REPO}/main/mmt/rometrics_mmt_library.md?cache=${Date.now()}`;
let SECTIONS=[], selectedId=null;

(async function loadMD(){
  try{
    let r=await fetch(PAGES_MD); if(!r.ok) r=await fetch(RAW_MD);
    const text=await r.text(); parseAndRender(text);
  }catch(e){ document.getElementById('md').innerHTML='<div class="detail-body">Error loading library.</div>'; }
})();

function parseAndRender(t){
  const lines=t.split(/\n/), map=[]; let scope='upper';
  for(let i=0;i<lines.length;i++){
    if(/^##\s+Upper/i.test(lines[i])) scope='upper';
    if(/^##\s+Lower/i.test(lines[i])) scope='lower';
    if(/^###\s+/.test(lines[i])) map.push({idx:i,scope});
  }
  SECTIONS=[];
  for(let j=0;j<map.length;j++){
    const start=map[j].idx, end=(map[j+1]?map[j+1].idx:lines.length);
    const block=lines.slice(start,end).join('\n');
    const m=block.match(/^###\s+(.+)$/m); if(!m) continue;
    const id=m[1].toLowerCase().replace(/[^a-z0-9]+/g,'-');
    SECTIONS.push({id,scope:map[j].scope,title:m[1],html:marked.parse(block)});
  }
  rebuildTestList();
}

/* ---------- Compact picker logic ---------- */
const scopeSel=document.getElementById('scope');
const qInput=document.getElementById('q');
const testSel=document.getElementById('test');

function rebuildTestList(){
  const scope=scopeSel.value, q=(qInput.value||'').toLowerCase();
  const items=SECTIONS.filter(s=>(scope==='all'||s.scope===scope)&&(!q||s.title.toLowerCase().includes(q)));
  testSel.innerHTML = items.map(s=>`<option value="${s.id}">${s.title}</option>`).join('');
}

scopeSel.addEventListener('change', rebuildTestList);
qInput.addEventListener('input', rebuildTestList);

testSel.addEventListener('change', ()=>{
  const id=testSel.value;
  if(!id) return;
  openTest(id);
});
testSel.addEventListener('dblclick', ()=>{ if(testSel.value) openTest(testSel.value); });

/* ---------- In-card overlay behavior (no floating) ---------- */
const detail=document.getElementById('detail');
const closeBtn=document.getElementById('closeBtn');

function openTest(id){
  selectedId=id;
  const s=SECTIONS.find(x=>x.id===id); if(!s) return;
  document.getElementById('accordion').innerHTML=s.html;
  openDetail();
}

function openDetail(){ detail.classList.add('open'); }
function closeDetail(){ detail.classList.remove('open'); selectedId=null; }

closeBtn.onclick=closeDetail;
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDetail(); });

/* ---------- Optional: auto-load stick model if present ---------- */
(async function loadStageModel(){
  const el=document.getElementById('stageModel');
  const candidates = [
    '/ROMetrics/goniometry-trainer/assets/stick.glb',
    '/ROMetrics/goniometry-trainer/stick.glb',
    './assets/stick.glb'
  ];
  for(const url of candidates){
    try{
      const res = await fetch(url, { method:'HEAD' });
      if(res.ok){ el.src = url; el.style.display='block'; return; }
    }catch(_){}
  }
})();
</script>
</body>
</html>
