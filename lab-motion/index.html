<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROMetrics — Hands Placement Fix</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#0e1420; color:#d9e2f1; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    #app { position:fixed; inset:0; display:grid; grid-template-rows:auto 1fr; }
    header { padding:10px 12px; display:flex; gap:8px; align-items:center; background:#0b1020; border-bottom:1px solid #1e2a44; }
    header h1 { font-size:16px; margin:0 8px 0 0; font-weight:600; color:#b8ccff; }
    button, .mini {
      background:#1a2744; color:#cfe1ff; border:1px solid #2a3b63; border-radius:10px;
      padding:6px 10px; font-size:12px; cursor:pointer;
    }
    button.on { background:#2a3b63; }
    button:hover { filter:brightness(1.1); }
    details { margin:6px 0 0 0; }
    summary { cursor:pointer; color:#cfe1ff; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .seg { display:flex; gap:6px; }
    #hud { position:fixed; left:10px; bottom:10px; font-size:12px; color:#9fb0c9; user-select:none; }
    #msg { margin-left:auto; color:#9fd3ff; font-size:12px; }
    canvas { display:block; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>ROMetrics</h1>
    <div class="row">
      <button id="handsBtn" class="mini">✋ Hands</button>
    </div>
    <div id="msg"></div>
  </header>

  <div id="panel" style="padding:8px 12px; border-bottom:1px solid #1e2a44;">
    <details id="handsPanel" style="display:none">
      <summary>Hands (placement)</summary>
      <div class="seg" style="margin-top:8px">
        <button id="handPickA" class="on">Active: Stabilize</button>
        <button id="handPickB">Active: Test</button>
      </div>
      <div class="row" style="margin-top:6px">
        <button id="handToggle" class="mini">Hide / Show</button>
        <button id="handReset" class="mini">Reset</button>
        <button id="handDel" class="mini">Remove</button>
      </div>
      <small style="color:#9fb0c9">Tip: drag to move; press <b>R</b> to switch rotate/translate; <b>X/Y/Z</b> to lock axes.</small>
    </details>
  </div>

  <div id="scene" style="position:relative;"></div>
</div>

<div id="hud">LMB = orbit • Shift+LMB = pan • Wheel = zoom</div>

<script type="module">
// ===== Imports (CDN) =====
import * as THREE from "https://unpkg.com/three@0.159.0/build/three.module.js";
import { OrbitControls } from "https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js";
import { TransformControls } from "https://unpkg.com/three@0.159.0/examples/jsm/controls/TransformControls.js";
import { GLTFLoader } from "https://unpkg.com/three@0.159.0/examples/jsm/loaders/GLTFLoader.js";

// ===== Basic scene =====
const root = document.getElementById("scene");
const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(innerWidth, innerHeight - document.querySelector("header").offsetHeight - document.getElementById("panel").offsetHeight);
renderer.shadowMap.enabled = true;
root.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0e1420);

const camera = new THREE.PerspectiveCamera(55, renderer.domElement.width/renderer.domElement.height, 0.1, 100);
camera.position.set(1.8, 1.3, 2.1);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.target.set(0, 1.0, 0);

// Lights & ground
const hemi = new THREE.HemisphereLight(0xffffff, 0x334466, 0.6);
scene.add(hemi);
const key = new THREE.DirectionalLight(0xffffff, 1.1);
key.position.set(2, 4, 2);
key.castShadow = true;
key.shadow.mapSize.set(2048,2048);
scene.add(key);

const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(10,10),
  new THREE.MeshStandardMaterial({color:0x0c1326, roughness:0.9, metalness:0})
);
ground.rotation.x = -Math.PI/2;
ground.position.y = 0;
ground.receiveShadow = true;
scene.add(ground);

// Simple mannequin proxy (optional visual reference)
const ref = new THREE.Mesh(
  new THREE.CapsuleGeometry(0.25, 1.2, 16, 32),
  new THREE.MeshStandardMaterial({color:0x334a7b, metalness:0, roughness:0.7, transparent:true, opacity:0.25})
);
ref.position.set(0, 0.85, 0);
ref.castShadow = true; ref.receiveShadow = true;
scene.add(ref);

// ===== Resize
function onResize(){
  const h = innerHeight - document.querySelector("header").offsetHeight - document.getElementById("panel").offsetHeight;
  renderer.setSize(innerWidth, h);
  camera.aspect = renderer.domElement.width / renderer.domElement.height;
  camera.updateProjectionMatrix();
}
addEventListener("resize", onResize);

// ===== Hands loader & placement =====
const msg = document.getElementById("msg");
const loader = new GLTFLoader();
const HAND_URL = "../assets/hand_only.glb"; // adjust if index location differs

let handA = null, handB = null;       // A = Stabilize, B = Test
let handsVisible = true;
const tctrl = new TransformControls(camera, renderer.domElement);
scene.add(tctrl);
tctrl.addEventListener("dragging-changed", e => controls.enabled = !e.value);
let activeHand = "A";

function log(t){ msg.textContent = t; }

function addShadow(o){
  o.traverse(n => { if (n.isMesh){ n.castShadow = true; n.receiveShadow = true; } });
}

function spawnHandsFrom(gltf){
  // base hand
  const base = gltf.scene;
  addShadow(base);
  base.scale.setScalar(1);
  base.rotation.set(0,0,0);
  base.position.set(0.30, 1.05, 0.55); // default near right shoulder

  // duplicate
  const dup = base.clone(true);
  dup.position.set(-0.30, 1.05, 0.55);

  handA = base; // Stabilize
  handB = dup;  // Test
  scene.add(handA, handB);
  tctrl.attach(handA);
  activeHand = "A";
  document.getElementById("handsPanel").style.display = "";
  document.getElementById("handsPanel").open = true;
  log("Hands added (Stabilize + Test). Drag to place; press R to rotate.");
}

async function ensureHandsLoaded(){
  return new Promise((resolve,reject)=>{
    if (handA && handB) return resolve();
    loader.load(HAND_URL, (gltf)=>{ spawnHandsFrom(gltf); resolve(); },
      undefined, (e)=>{ log("⚠️ Hand load error"); console.error(e); reject(e); });
  });
}

function setHandsVisible(v){
  handsVisible = v;
  if (handA) handA.visible = v;
  if (handB) handB.visible = v;
  log(v ? "Hands shown" : "Hands hidden");
}

function resetHands(){
  if (!handA || !handB) return;
  handA.position.set(0.30, 1.05, 0.55); handA.rotation.set(0,0,0);
  handB.position.set(-0.30, 1.05, 0.55); handB.rotation.set(0,0,0);
  tctrl.attach(activeHand==="A" ? handA : handB);
  log("Hands reset");
}

function removeHands(){
  if (handA){ scene.remove(handA); handA = null; }
  if (handB){ scene.remove(handB); handB = null; }
  tctrl.detach();
  document.getElementById("handsPanel").style.display = "none";
  log("Hands removed");
}

// ===== UI wiring =====
const handsBtn   = document.getElementById("handsBtn");
const handPickA  = document.getElementById("handPickA");
const handPickB  = document.getElementById("handPickB");
const handToggle = document.getElementById("handToggle");
const handReset  = document.getElementById("handReset");
const handDel    = document.getElementById("handDel");

handsBtn.onclick = async ()=>{
  try{
    await ensureHandsLoaded();
  }catch(e){ /* handled above */ }
};

handPickA.onclick = ()=>{ if (!handA) return;
  activeHand="A"; handPickA.classList.add("on"); handPickB.classList.remove("on");
  tctrl.attach(handA); log("Active hand: Stabilize");
};
handPickB.onclick = ()=>{ if (!handB) return;
  activeHand="B"; handPickB.classList.add("on"); handPickA.classList.remove("on");
  tctrl.attach(handB); log("Active hand: Test");
};

handToggle.onclick = ()=> setHandsVisible(!handsVisible);
handReset.onclick  = ()=> resetHands();
handDel.onclick    = ()=> removeHands();

// ===== Keyboard helpers =====
tctrl.setMode("translate"); // default
window.addEventListener("keydown", (e)=>{
  const k = e.key.toLowerCase();
  if (k === "r"){ tctrl.setMode( tctrl.mode==="translate" ? "rotate" : "translate" ); }
  if (["x","y","z"].includes(k)){ tctrl.setTranslationSnap(null); tctrl.setRotationSnap(null); tctrl.setSpace("world"); tctrl.showX = k==="x"; tctrl.showY = k==="y"; tctrl.showZ = k==="z"; }
});

// ===== Loop =====
renderer.setAnimationLoop(()=>{
  controls.update();
  renderer.render(scene, camera);
});
onResize();
log("Ready — click ✋ Hands to load the model from ../assets/hand_only.glb");
</script>
</body>
</html>

