<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROMetrics — Panel Base (FIX)</title>
  <style>
    :root { --bg:#0e1420; --panel:#0b1020; --line:#1e2a44; --txt:#dbe7ff; --muted:#9fb0c9; }
    html,body { margin:0; height:100%; background:var(--bg); color:var(--txt); font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    #stage { position:fixed; inset:0; }
    #msg { position:fixed; left:12px; bottom:12px; background:#0b1020; border:1px solid var(--line); padding:6px 10px; border-radius:10px; font-size:12px; z-index:20; }
    .panel { position:fixed; left:12px; top:12px; width:340px; max-height:86vh; overflow:auto;
             background:var(--panel); border:1px solid var(--line); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.45); z-index:15; }
    .dragbar { cursor:move; padding:10px 12px; font-weight:600; color:#b8ccff; border-bottom:1px solid var(--line); user-select:none; display:flex; gap:8px; align-items:center; }
    .dragbar .hint { margin-left:auto; color:var(--muted); font-weight:400; font-size:12px; }
    .content { padding:10px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:8px 0; }
    button.mini { background:#1a2744; color:#cfe1ff; border:1px solid #2a3b63; border-radius:10px; padding:6px 10px; font-size:12px; cursor:pointer; }
    button.mini:hover { filter:brightness(1.1) }
    canvas { display:block; width:100%; height:100%; }
  </style>
</head>
<body>
<div id="stage">
  <canvas id="canvas"></canvas>
</div>

<div class="panel" id="panel">
  <div class="dragbar" id="dragbar">🧭 Joint Lab <span class="hint">drag me</span></div>
  <div class="content">
    <div class="row">
      <button id="reload" class="mini">Reload Model</button>
    </div>
  </div>
</div>

<div id="msg">Booting…</div>

<script type="module">
import * as THREE from "https://unpkg.com/three@0.159.0/build/three.module.js";
import { OrbitControls } from "https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js";
import { GLTFLoader } from "https://unpkg.com/three@0.159.0/examples/jsm/loaders/GLTFLoader.js";

const canvas = document.getElementById("canvas");
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
resizeRenderer();

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0e1420);

const camera = new THREE.PerspectiveCamera(55, canvas.clientWidth / canvas.clientHeight, 0.1, 200);
camera.position.set(1.8, 1.3, 2.1);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.target.set(0, 1.0, 0);

const hemi = new THREE.HemisphereLight(0xffffff, 0x334466, 0.6);
scene.add(hemi);
const key = new THREE.DirectionalLight(0xffffff, 1.1);
key.position.set(2, 4, 2); key.castShadow = true; key.shadow.mapSize.set(2048,2048);
scene.add(key);

const ground = new THREE.Mesh(new THREE.PlaneGeometry(20,20), new THREE.MeshStandardMaterial({color:0x0c1326, roughness:0.9, metalness:0}));
ground.rotation.x = -Math.PI/2; ground.receiveShadow = true;
scene.add(ground);

let model = null;
const loader = new GLTFLoader();
const msg = document.getElementById("msg");

function resizeRenderer(){
  renderer.setSize(window.innerWidth, window.innerHeight, false);
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
}
window.addEventListener("resize", resizeRenderer);

function fitView(target = model || scene){
  const box = new THREE.Box3().setFromObject(target);
  const size = box.getSize(new THREE.Vector3()).length();
  const center = box.getCenter(new THREE.Vector3());
  const fitHeightDistance = size / (2 * Math.atan((Math.PI * camera.fov / 360)));
  const fitWidthDistance = fitHeightDistance / camera.aspect;
  const distance = Math.max(fitHeightDistance, fitWidthDistance);
  const direction = new THREE.Vector3().subVectors(camera.position, controls.target).normalize();
  controls.target.copy(center);
  camera.position.copy(direction.multiplyScalar(distance).add(controls.target));
  camera.near = distance / 100; camera.far = distance * 100; camera.updateProjectionMatrix();
  controls.update();
}

async function loadGLB(url){
  if (model){ scene.remove(model); model = null; }
  msg.textContent = "Loading model…";
  return new Promise((resolve, reject)=>{
    loader.load(url,
      (gltf)=>{
        model = gltf.scene;
        model.traverse(n=>{ if(n.isMesh){ n.castShadow = true; n.receiveShadow = true; } });
        scene.add(model);
        msg.textContent = "✅ Model loaded";
        fitView(model);
        resolve(model);
      },
      undefined,
      (err)=>{ console.error(err); msg.textContent = "⚠️ Load failed: " + (err?.message||err); reject(err); }
    );
  });
}

function getParam(name){ const u=new URL(location.href); return u.searchParams.get(name); }
function defaultModel(){ return "./Athletic_Grace_1006002620_texture.glb"; }

(async function boot(){
  try{
    const q = getParam("model");
    await loadGLB(q || defaultModel());
  }catch(e){
    msg.textContent = "⚠️ Could not load model. Click 'Reload Model'.";
  }
})();

document.getElementById("reload").addEventListener("click", async ()=>{
  const cur = getParam("model") || defaultModel();
  const url = prompt("Enter GLB/GLTF URL", cur);
  if (!url) return;
  await loadGLB(url);
  const u = new URL(location.href); u.searchParams.set("model", url); history.replaceState(null, "", u.toString());
});

renderer.setAnimationLoop(()=>{ controls.update(); renderer.render(scene, camera); });

// Dragging for the floating panel
(function(){
  const panel = document.getElementById("panel");
  const bar = document.getElementById("dragbar");
  let dragging=false, sx=0, sy=0, ox=panel.offsetLeft, oy=panel.offsetTop;

  function onDown(e){
    dragging=true; sx=e.clientX; sy=e.clientY;
    ox=panel.offsetLeft; oy=panel.offsetTop;
    document.addEventListener("pointermove", onMove);
    document.addEventListener("pointerup", onUp, {once:true});
  }
  function onMove(e){
    if (!dragging) return;
    const dx=e.clientX - sx, dy=e.clientY - sy;
    panel.style.left = Math.max(6, Math.min(window.innerWidth - panel.offsetWidth - 6, ox + dx)) + "px";
    panel.style.top  = Math.max(6, Math.min(window.innerHeight - panel.offsetHeight - 6, oy + dy)) + "px";
  }
  function onUp(){ dragging=false; document.removeEventListener("pointermove", onMove); }

  bar.addEventListener("pointerdown", onDown);
})();

// Optional Add-ons (safe)
(async () => {
  const base = "./addons/";
  for (const f of ["hands_addon.js", "posture_addon.js", "regions_actions_addon.js"]) {
    try { await import(base + f); } catch (e) { console.info("Add-on not found:", f); }
  }
})();
</script>
</body>
</html>
