<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROMetrics — Modular Minimal (Fixed Paths)</title>
  <style>
    html,body {margin:0;height:100%;background:#0e1420;color:#dbe7ff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #app {position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr}
    header {display:flex;align-items:center;gap:8px;padding:8px 10px;background:#0b1020;border-bottom:1px solid #1e2a44}
    header h1 {font-size:14px;margin:0;color:#b8ccff;font-weight:600}
    button.mini {background:#1a2744;color:#cfe1ff;border:1px solid #2a3b63;border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer}
    button.mini:hover{filter:brightness(1.1)}
    .panel {position:fixed;right:12px;top:12px;width:300px;max-height:85vh;overflow:auto;background:#0b1020;border:1px solid #1e2a44;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .panel header {position:sticky;top:0;z-index:2;background:#0b1020;border-bottom:1px solid #1e2a44}
    .panel .content {padding:10px}
    .row {display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
    label {display:block;color:#a9b8d9;margin:8px 0 4px;font-size:12px;text-transform:uppercase;letter-spacing:.06em}
    #msg {margin-left:auto;color:#9fd3ff;font-size:12px}
    canvas{display:block}
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>ROMetrics</h1>
    <div class="row">
      <button id="reload" class="mini">Reload Model</button>
    </div>
    <div id="msg"></div>
  </header>
  <div id="stage"></div>
</div>

<div class="panel">
  <header class="row"><strong>Controls</strong></header>
  <div class="content"><!-- Add-ons inject here --></div>
</div>

<script type="module">
import * as THREE from "https://unpkg.com/three@0.159.0/build/three.module.js";
import { OrbitControls } from "https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js";
import { GLTFLoader } from "https://unpkg.com/three@0.159.0/examples/jsm/loaders/GLTFLoader.js";

// Expose for add-ons
window.THREE = THREE;

const root = document.getElementById("stage");
const msg  = document.getElementById("msg");
const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(innerWidth, innerHeight - document.querySelector("header").offsetHeight);
renderer.shadowMap.enabled = true;
root.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0e1420);

const camera = new THREE.PerspectiveCamera(55, renderer.domElement.width/renderer.domElement.height, 0.1, 100);
camera.position.set(1.8, 1.3, 2.1);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.target.set(0, 1.0, 0);

scene.add(new THREE.HemisphereLight(0xffffff, 0x334466, 0.6));
const key = new THREE.DirectionalLight(0xffffff, 1.1);
key.position.set(2, 4, 2);
key.castShadow = true;
key.shadow.mapSize.set(2048,2048);
scene.add(key);

const ground = new THREE.Mesh(new THREE.PlaneGeometry(20,20),
  new THREE.MeshStandardMaterial({color:0x0c1326, roughness:0.9, metalness:0}));
ground.rotation.x = -Math.PI/2; ground.position.y = 0; ground.receiveShadow = true;
scene.add(ground);

window.scene = scene;
window.camera = camera;
window.renderer = renderer;
window.controls = controls;
window.model = null;

const loader = new GLTFLoader();
function fitView(target= window.model || scene){
  const box = new THREE.Box3().setFromObject(target);
  const size = box.getSize(new THREE.Vector3()).length();
  const center = box.getCenter(new THREE.Vector3());
  const fitHeightDistance = size / (2 * Math.atan((Math.PI * camera.fov / 360)));
  const fitWidthDistance = fitHeightDistance / camera.aspect;
  const distance = Math.max(fitHeightDistance, fitWidthDistance);
  const direction = new THREE.Vector3().subVectors(camera.position, controls.target).normalize();
  controls.target.copy(center);
  camera.position.copy(direction.multiplyScalar(distance).add(controls.target));
  camera.near = distance / 100; camera.far = distance * 100; camera.updateProjectionMatrix();
  controls.update();
}

async function loadModel(url){
  if (window.model){ scene.remove(window.model); window.model = null; }
  msg.textContent = "Loading…";
  return new Promise((resolve,reject)=>{
    loader.load(url, (gltf)=>{
      window.model = gltf.scene;
      window.model.traverse(n=>{ if(n.isMesh){n.castShadow=true;n.receiveShadow=true;} });
      scene.add(window.model);
      msg.textContent = "✅ Model loaded";
      fitView(window.model);
      resolve(window.model);
    }, undefined, (err)=>{ console.error(err); msg.textContent = "⚠️ Load failed"; reject(err); });
  });
}

function getParam(name){ const u=new URL(location.href); return u.searchParams.get(name); }
async function boot(){
  const q = getParam("model");
  const url = q || "./Athletic_Grace_1006002620_texture.glb"; // change if needed
  try{ await loadModel(url); }catch{}
}
boot();

document.getElementById("reload").onclick = async ()=>{
  const cur = getParam("model") || "./Athletic_Grace_1006002620_texture.glb";
  const url = prompt("Enter GLB/GLTF URL", cur);
  if (url){ await loadModel(url); history.replaceState(null, "", "?model="+encodeURIComponent(url)); }
};

addEventListener("resize", ()=>{
  const h = innerHeight - document.querySelector("header").offsetHeight;
  renderer.setSize(innerWidth, h); camera.aspect = renderer.domElement.width / renderer.domElement.height;
  camera.updateProjectionMatrix();
});

renderer.setAnimationLoop(()=>{ controls.update(); renderer.render(scene, camera); });
</script>

<!-- Fixed paths to /addons/ -->
<script src="./addons/hands_addon.js"></script>
<script src="./addons/posture_addon.js"></script>
<script src="./addons/regions_actions_addon.js"></script>
</body>
</html>
